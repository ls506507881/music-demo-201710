<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./reset.css">
    <title>播放</title>
    <style>
        .page{
            height: 100vh;
            position: relative;
        }
        .pagebg{
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            top: 0;
            background: transparent url(//oxkl41ihc.bkt.clouddn.com/%E8%BF%9C%E8%B5%B0%E9%AB%98%E9%A3%9E.jpg)
            no-repeat center;
            background-size: cover;
            filter: blur(20px) brightness(.3);
            z-index: -1;
        }
        .pagebg::after{
            content: "";
            height: 100%;
            width: 100%;
            top: 0;
            left: 0;
            background-color: rgba(0,0,0,.5);
        }
        section.pointer>img{
            width: 84px;
            position: absolute;
            left: 45%;
            z-index: 1;
        }
        section.disk{
            padding-top: 63px;
        }
        section.disk .circle{
            width: 248px;
            height: 248px;
            margin: 0 auto;            
            position: relative;
        }
        section.disk .circle::before{
            content: "";
            background: transparent url(//oxkl41ihc.bkt.clouddn.com/disc.png) 
            no-repeat center;
            background-size: cover;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        section.disk .circle::after{
            content: "";
            background: transparent url(//oxkl41ihc.bkt.clouddn.com/disc_light.png)
            no-repeat center;
            background-size: cover;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        section.disk .circle > img{
            width: 150px;
            height: 150px;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-left: -75px;
            margin-top: -75px;
            border-radius: 50%;
        }
        section.disk .circle.playing > img,
        section.disk .circle.playing::after{
            animation: spin 10s linear infinite;
        }
        section.disk .circle.playing.pause > img,
        section.disk .circle.playing.pause::after{
            animation-play-state: paused;
        }

        section.song-description{
            margin-top: 25px;
            padding: 0 35px;
            text-align: center;
        }
        section.song-description > h2{
            font-size: 15px;
            line-height: 1.1;
            color: #fff;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            
        }
        section.song-description > h2 > small{
            font-size: 13px;
            color: #BCB69B;
        }
        section.song-description>.lyric{
            transition: transform 0.3s;
            height: 72px;
            margin-top: 14px;
            overflow: hidden;
            font-size: 13px;
            line-height: 1.5;
            /* border: 1px solid red; */
        }
        section.song-description>.lyric .scroll p{
            color: #B4A8A1;
            line-height: 2;
        }
        section.song-description>.lyric p.active{
            color: #fff;
        }

        section.actions{
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            padding: 0 35px;
            display: flex;
        }
        section.actions a{
            flex: 1 1 auto;
            border: 1px solid red;
            border-radius: 5px;
            margin-left: 12px;
        }
        section.actions .btn{
            height: 36px;
            line-height: 36px;
            padding: 0 6px;
            border: 1px solid #adadad;
            border-radius: 4px;
            font-size: 15px;
            box-sizing: content-box;
            text-align: center;
        }
        section.actions .btn:first-child{
            margin-left: 0;
            color: #d43b32;
            border-color: #d43b32;
        }
        section.actions .btn:last-child{
            background-color: #d43b32;
            border-color: #d43b32;
            color: #fff;
        }
        @keyframes spin{
            0%{
                transform: rotateZ(0deg);
            }
            100%{
                transform: rotateZ(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <div id="pagebg">
        </div>
        <section class="pointer">
            <img src="//oxkl41ihc.bkt.clouddn.com/needle.png" alt="">
        </section>
        <section class="disk">
            <div id="playCover" class="circle playing">
            </div>
        </section>
        <section class="song-description">
            <h2 id="des-name">
            </h2>
            <div class="lyric">
                <div class="scroll">
                </div>
            </div>
        </section>
        <section class="actions">
            <a class="btn">打 开</a>
            <a class="btn">下 载</a>
        </section>
    </div>
    <script src="./vendors/jquery.min.js"></script>
    <script src="./vendors/av-min.js"></script>
    <script src="./scripts/av.js"></script>
    <script>
        //获取id
        function getParameterByName(name,url){
            if(!url) url = window.location.href;
            name = name.replace(/[\[\]]/g,"\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if(!results) return null;
            if(!results[2]) return ' ';
            return decodeURIComponent(results[2].replace(/\+/g," "));
        }

        let id = getParameterByName('id');
        var query = new AV.Query('Song');
        query.get(id).then(function (song) {
            let {url,lyric} = song.attributes
            let video = document.createElement('video')
            video.src = url
            video.play()
            let array = []
            let parts = lyric.split('\n')
            parts.forEach(function(string,index) {
                let xxx = string.split(']')
                xxx[0] = xxx[0].substring(1)
                let regex = /(\d+):([\d.]+)/
                let matches = xxx[0].match(regex)
                let minute = +matches[1]
                let seconds = +matches[2]
                array.push({
                    time: minute*60+seconds,
                    lyric: xxx[1]
                })
            });

            //歌曲
            var $deSname = $('#des-name')
            var $playCover = $('#playCover')
            var $playbg = $('#pagebg')
            var querysong = new AV.Query('Song');
            querysong.find().then(function (results) {
                let {name,singer,cover} = song.attributes
                let h2 = `
                <span>${name}</span>
                <span>-</span>
                <small>${singer}</small>
                `
                let img = `
                    <img src="${cover}" alt="封面">
                `
                let pagebg = `
                    <div class="pagebg" style="background: transparent url(${cover}) no-repeat center;"></div>
                `
                $deSname.append(h2)
                $playCover.append(img)
                $playbg.append(pagebg)
            }, function (error) {
            alert('获取歌名标题失败')
            });

            //把歌词添加到页面上
            array.map(function(object){
                    if(!object){return}
                    let $scroll = $('.scroll')
                    let $p=$('<p/>')
                    $p.attr('data-time',object.time).text(object.lyric)
                    $p.appendTo($scroll)
                })

            setInterval(function(){
                let $scrolls = $('.scroll>p')
                let current = video.currentTime
                let $whichLine;
                for(var i=0;i<array.length;i++){
                    let currentLineTime = $scrolls.eq(i).attr('data-time');
                    let nextLineTime = $scrolls.eq(i+1).attr('data-time');
                    if( i === array.length -1){
                        // console.log(array[i].time)
                        $whichLine = $scrolls.eq(i)
                    }else if( array[i+1] !=undefined && currentLineTime <= current && nextLineTime >current){
                        $whichLine = $scrolls.eq(i)
                        break;
                    }
                }
                if($whichLine){
                    $whichLine.addClass('active').prev().removeClass('active')
                    let top = $whichLine.offset().top
                    let scrollTop = $('.scroll').offset().top
                    let delta = top - scrollTop -  $('.lyric').height()/3
                    $('.scroll').css('transform',`translateY(-${delta}px)`)
                }
            },500)
        })
    </script>
</body>
</html>